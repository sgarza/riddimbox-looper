{"version":3,"file":"index.umd.bundle.js","sources":["../src/looper.js","../src/constants.js","../src/providers/tone-mediarecorder-provider.js","../src/providers/riddimbox-transport-provider.js"],"sourcesContent":["class Looper {\n  static _mediaRecorderProvider = null;\n  static _transportProvider = null;\n\n  static get mediaRecorderProvider() {\n    Looper._throwIfMediaRecorderProvderNotSet();\n    return Looper._mediaRecorderProvider;\n  }\n\n  static get transportProvider() {\n    Looper._throwIfTransportProviderNotSet();\n    return Looper._transportProvider;\n  }\n\n  static get loops() {\n    return Looper.mediaRecorderProvider.loops;\n  }\n\n  static get currentLoopLength() {\n    return Looper.transportProvider.currentLoopLength;\n  }\n\n  static set mediaRecorderProvider(mediaRecorderProvider) {\n    Looper._mediaRecorderProvider = mediaRecorderProvider;\n  }\n\n  static set transportProvider(transportProvider) {\n    Looper._transportProvider = transportProvider;\n\n    Looper._setupTransportEvents();\n  }\n\n  static set input(input) {\n    Looper.mediaRecorderProvider.input = input;\n  }\n\n  static set output(output) {\n    Looper.mediaRecorderProvider.output = output;\n  }\n\n  static startRecording() {\n    Looper.mediaRecorderProvider.startRecording();\n  }\n\n  static stopRecording() {\n    Looper.mediaRecorderProvider.stopRecording();\n  }\n\n  static restartRecording() {\n    Looper.mediaRecorderProvider.stopRecording();\n    Looper.mediaRecorderProvider.startRecording();\n  }\n\n  static selectCurrentLoop() {\n    Looper._throwIfTransportProviderNotSet();\n    Looper.mediaRecorderProvider.selectCurrentLoop = true;\n  }\n\n  static increaseCurrentLoopLength() {\n    Looper.transportProvider.increaseCurrentLoopLength();\n    Looper.mediaRecorderProvider.currentLoopLength = Looper.currentLoopLength;\n  }\n\n  static decreaseCurrentLoopLength() {\n    Looper.transportProvider.decreaseCurrentLoopLength();\n    Looper.mediaRecorderProvider.currentLoopLength = Looper.currentLoopLength;\n  }\n\n  static playbackLoops({ totalBeats }) {\n    const startTimeOffset = Looper.mediaRecorderProvider.ticksToTime;\n\n    Looper.loops\n      .filter(loop => totalBeats % loop.length === 0)\n      .forEach(loop =>\n        loop.player.start(\n          Looper.mediaRecorderProvider.currentTime,\n          startTimeOffset\n        )\n      );\n  }\n\n  static _throwIfMediaRecorderProvderNotSet() {\n    if (!Looper._mediaRecorderProvider) {\n      throw new Error(\n        \"You need to set a MediaRecorderProvider first, try with ToneMediaRecorderProvider class.\"\n      );\n    }\n  }\n\n  static _throwIfTransportProviderNotSet() {\n    if (!Looper._transportProvider) {\n      throw new Error(\n        \"You need to set a TransportProvider first, try with RiddimBoxTransportProvider class.\"\n      );\n    }\n  }\n\n  static _setupTransportEvents() {\n    Looper.transportProvider.on(\"start\", Looper.startRecording);\n    Looper.transportProvider.on(\"stop\", Looper.stopRecording);\n    Looper.transportProvider.on(\"loop\", Looper.restartRecording);\n    Looper.transportProvider.on(\"beat\", Looper.playbackLoops);\n  }\n}\n\nexport default Looper;\n","export default {\n  MEDIA_RECORDER_RECORDING: \"recording\",\n  MEDIA_RECORDER_INACTIVE: \"inactive\",\n  MIN_LOOP_LENGTH: 4,\n  MAX_LOOP_LENGTH: 64,\n  DEFAULT_TICKS_TO_TIME_VALUE: 25\n};\n","import constants from \"../constants\";\nconst { PPQN, MIN_LOOP_LENGTH } = constants;\n\nclass ToneMediaRecorderProvider {\n  constructor(Tone, MediaRecorder) {\n    this.engine = Tone;\n    this.MediaRecorder = MediaRecorder;\n    this.recorderStreamDestination = null;\n    this.recorder = null;\n    this.selectCurrentLoop = false;\n    this.currentLoopLength = MIN_LOOP_LENGTH;\n    this.loops = [];\n    this._output = Tone.Master;\n\n    this._setupMediaRecorder();\n  }\n\n  get ticksToTime() {\n    const { bpm } = this.engine.Transport;\n    return bpm.ticksToTime(this.engine.Transport.ticks % PPQN);\n  }\n\n  get currentTime() {\n    return this.engine.context.currentTime;\n  }\n\n  set input(input) {\n    input.connect(this.recorderStreamDestination);\n  }\n\n  set output(output) {\n    this.loops.forEach(loop => {\n      loop.player.disconnect(this._output);\n      loop.player.connect(output);\n    });\n\n    this._output = output;\n  }\n\n  startRecording() {\n    this.recorder.start();\n  }\n\n  stopRecording() {\n    this.recorder.stop();\n  }\n\n  _setupMediaRecorder() {\n    this.recorderStreamDestination = this.engine.context.createMediaStreamDestination();\n    this.recorder = new this.MediaRecorder(\n      this.recorderStreamDestination.stream\n    );\n\n    this.recorder.ondataavailable = this._onDataAvailableHandler;\n  }\n\n  _onDataAvailableHandler(e) {\n    if (!this.selectCurrentLoop) return;\n\n    this.selectCurrentLoop = false;\n\n    const blob = new Blob([e.data], {\n      type: \"audio/webm;; codec=opus\"\n    });\n\n    const url = URL.createObjectURL(blob);\n\n    const buffer = new this.engine.Buffer(url, () => {\n      this._createBufferCallback(buffer);\n    });\n  }\n\n  _createBufferCallback(buffer) {\n    const player = new this.engine.Player(buffer);\n\n    player.connect(this._output);\n\n    const startTimeOffset = this.ticksToTime;\n\n    player.start(this.currentTime, startTimeOffset);\n\n    this.loops.push({\n      length: this.currentLoopLength,\n      player\n    });\n  }\n}\n\nexport default ToneMediaRecorderProvider;\n","import constants from \"../constants\";\nconst { MIN_LOOP_LENGTH, MAX_LOOP_LENGTH } = constants;\n\nclass RiddimBoxTransportProvider {\n  constructor(Transport) {\n    this.transport = Transport;\n    this.currentLoopLength = MIN_LOOP_LENGTH;\n\n    this.transport.on(\"beat\", ({ beats }) => {\n      if (beats % this.currentLoopLength === 0) {\n        this.transport.provider.emit(\"loop\");\n      }\n    });\n  }\n\n  on(event, handler) {\n    this.transport.on(event, handler);\n  }\n\n  increaseCurrentLoopLength() {\n    let length = this.currentLoopLength + MIN_LOOP_LENGTH;\n\n    if (length > MAX_LOOP_LENGTH) {\n      length = MIN_LOOP_LENGTH;\n    }\n\n    this.currentLoopLength = length;\n  }\n\n  decreaseCurrentLoopLength() {\n    let length = this.currentLoopLength - MIN_LOOP_LENGTH;\n\n    if (length < MIN_LOOP_LENGTH) {\n      length = MAX_LOOP_LENGTH;\n    }\n\n    this.currentLoopLength = length;\n  }\n}\n\nexport default RiddimBoxTransportProvider;\n"],"names":["Looper","mediaRecorderProvider","startRecording","stopRecording","_throwIfTransportProviderNotSet","selectCurrentLoop","transportProvider","increaseCurrentLoopLength","currentLoopLength","decreaseCurrentLoopLength","totalBeats","startTimeOffset","ticksToTime","loops","filter","loop","length","forEach","player","start","currentTime","_mediaRecorderProvider","Error","_transportProvider","on","restartRecording","playbackLoops","_throwIfMediaRecorderProvderNotSet","_setupTransportEvents","input","output","MEDIA_RECORDER_RECORDING","MEDIA_RECORDER_INACTIVE","MIN_LOOP_LENGTH","MAX_LOOP_LENGTH","DEFAULT_TICKS_TO_TIME_VALUE","PPQN","constants","ToneMediaRecorderProvider","Tone","MediaRecorder","engine","recorderStreamDestination","recorder","_output","Master","_setupMediaRecorder","stop","context","createMediaStreamDestination","stream","ondataavailable","_onDataAvailableHandler","e","blob","Blob","data","type","url","URL","createObjectURL","buffer","Buffer","_createBufferCallback","Player","connect","push","bpm","Transport","ticks","disconnect","RiddimBoxTransportProvider","transport","beats","provider","emit","event","handler"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;MAAMA;;;;;;;;;uCAwCoB;EACtBA,MAAAA,MAAM,CAACC,qBAAP,CAA6BC,cAA7B;EACD;;;sCAEsB;EACrBF,MAAAA,MAAM,CAACC,qBAAP,CAA6BE,aAA7B;EACD;;;yCAEyB;EACxBH,MAAAA,MAAM,CAACC,qBAAP,CAA6BE,aAA7B;EACAH,MAAAA,MAAM,CAACC,qBAAP,CAA6BC,cAA7B;EACD;;;0CAE0B;EACzBF,MAAAA,MAAM,CAACI,+BAAP;;EACAJ,MAAAA,MAAM,CAACC,qBAAP,CAA6BI,iBAA7B,GAAiD,IAAjD;EACD;;;kDAEkC;EACjCL,MAAAA,MAAM,CAACM,iBAAP,CAAyBC,yBAAzB;EACAP,MAAAA,MAAM,CAACC,qBAAP,CAA6BO,iBAA7B,GAAiDR,MAAM,CAACQ,iBAAxD;EACD;;;kDAEkC;EACjCR,MAAAA,MAAM,CAACM,iBAAP,CAAyBG,yBAAzB;EACAT,MAAAA,MAAM,CAACC,qBAAP,CAA6BO,iBAA7B,GAAiDR,MAAM,CAACQ,iBAAxD;EACD;;;0CAEoC;EAAA,UAAdE,UAAc,QAAdA,UAAc;EACnC,UAAMC,eAAe,GAAGX,MAAM,CAACC,qBAAP,CAA6BW,WAArD;EAEAZ,MAAAA,MAAM,CAACa,KAAP,CACGC,MADH,CACU,UAAAC,IAAI;EAAA,eAAIL,UAAU,GAAGK,IAAI,CAACC,MAAlB,KAA6B,CAAjC;EAAA,OADd,EAEGC,OAFH,CAEW,UAAAF,IAAI;EAAA,eACXA,IAAI,CAACG,MAAL,CAAYC,KAAZ,CACEnB,MAAM,CAACC,qBAAP,CAA6BmB,WAD/B,EAEET,eAFF,CADW;EAAA,OAFf;EAQD;;;2DAE2C;EAC1C,UAAI,CAACX,MAAM,CAACqB,sBAAZ,EAAoC;EAClC,cAAM,IAAIC,KAAJ,CACJ,0FADI,CAAN;EAGD;EACF;;;wDAEwC;EACvC,UAAI,CAACtB,MAAM,CAACuB,kBAAZ,EAAgC;EAC9B,cAAM,IAAID,KAAJ,CACJ,uFADI,CAAN;EAGD;EACF;;;8CAE8B;EAC7BtB,MAAAA,MAAM,CAACM,iBAAP,CAAyBkB,EAAzB,CAA4B,OAA5B,EAAqCxB,MAAM,CAACE,cAA5C;EACAF,MAAAA,MAAM,CAACM,iBAAP,CAAyBkB,EAAzB,CAA4B,MAA5B,EAAoCxB,MAAM,CAACG,aAA3C;EACAH,MAAAA,MAAM,CAACM,iBAAP,CAAyBkB,EAAzB,CAA4B,MAA5B,EAAoCxB,MAAM,CAACyB,gBAA3C;EACAzB,MAAAA,MAAM,CAACM,iBAAP,CAAyBkB,EAAzB,CAA4B,MAA5B,EAAoCxB,MAAM,CAAC0B,aAA3C;EACD;;;0BAlGkC;EACjC1B,MAAAA,MAAM,CAAC2B,kCAAP;;EACA,aAAO3B,MAAM,CAACqB,sBAAd;EACD;wBAegCpB,uBAAuB;EACtDD,MAAAA,MAAM,CAACqB,sBAAP,GAAgCpB,qBAAhC;EACD;;;0BAf8B;EAC7BD,MAAAA,MAAM,CAACI,+BAAP;;EACA,aAAOJ,MAAM,CAACuB,kBAAd;EACD;wBAc4BjB,mBAAmB;EAC9CN,MAAAA,MAAM,CAACuB,kBAAP,GAA4BjB,iBAA5B;;EAEAN,MAAAA,MAAM,CAAC4B,qBAAP;EACD;;;0BAhBkB;EACjB,aAAO5B,MAAM,CAACC,qBAAP,CAA6BY,KAApC;EACD;;;0BAE8B;EAC7B,aAAOb,MAAM,CAACM,iBAAP,CAAyBE,iBAAhC;EACD;;;wBAYgBqB,OAAO;EACtB7B,MAAAA,MAAM,CAACC,qBAAP,CAA6B4B,KAA7B,GAAqCA,KAArC;EACD;;;wBAEiBC,QAAQ;EACxB9B,MAAAA,MAAM,CAACC,qBAAP,CAA6B6B,MAA7B,GAAsCA,MAAtC;EACD;;;;;;kBAtCG9B,kCAC4B;;kBAD5BA,8BAEwB;;ACF9B,kBAAe;EACb+B,EAAAA,wBAAwB,EAAE,WADb;EAEbC,EAAAA,uBAAuB,EAAE,UAFZ;EAGbC,EAAAA,eAAe,EAAE,CAHJ;EAIbC,EAAAA,eAAe,EAAE,EAJJ;EAKbC,EAAAA,2BAA2B,EAAE;EALhB,CAAf;;MCCQC,OAA0BC,UAA1BD;MAAMH,kBAAoBI,UAApBJ;;MAERK;;;EACJ,qCAAYC,IAAZ,EAAkBC,aAAlB,EAAiC;EAAA;;EAC/B,SAAKC,MAAL,GAAcF,IAAd;EACA,SAAKC,aAAL,GAAqBA,aAArB;EACA,SAAKE,yBAAL,GAAiC,IAAjC;EACA,SAAKC,QAAL,GAAgB,IAAhB;EACA,SAAKtC,iBAAL,GAAyB,KAAzB;EACA,SAAKG,iBAAL,GAAyByB,eAAzB;EACA,SAAKpB,KAAL,GAAa,EAAb;EACA,SAAK+B,OAAL,GAAeL,IAAI,CAACM,MAApB;;EAEA,SAAKC,mBAAL;EACD;;;;uCAwBgB;EACf,WAAKH,QAAL,CAAcxB,KAAd;EACD;;;sCAEe;EACd,WAAKwB,QAAL,CAAcI,IAAd;EACD;;;4CAEqB;EACpB,WAAKL,yBAAL,GAAiC,KAAKD,MAAL,CAAYO,OAAZ,CAAoBC,4BAApB,EAAjC;EACA,WAAKN,QAAL,GAAgB,IAAI,KAAKH,aAAT,CACd,KAAKE,yBAAL,CAA+BQ,MADjB,CAAhB;EAIA,WAAKP,QAAL,CAAcQ,eAAd,GAAgC,KAAKC,uBAArC;EACD;;;8CAEuBC,GAAG;EAAA;;EACzB,UAAI,CAAC,KAAKhD,iBAAV,EAA6B;EAE7B,WAAKA,iBAAL,GAAyB,KAAzB;EAEA,UAAMiD,IAAI,GAAG,IAAIC,IAAJ,CAAS,CAACF,CAAC,CAACG,IAAH,CAAT,EAAmB;EAC9BC,QAAAA,IAAI,EAAE;EADwB,OAAnB,CAAb;EAIA,UAAMC,GAAG,GAAGC,GAAG,CAACC,eAAJ,CAAoBN,IAApB,CAAZ;EAEA,UAAMO,MAAM,GAAG,IAAI,KAAKpB,MAAL,CAAYqB,MAAhB,CAAuBJ,GAAvB,EAA4B,YAAM;EAC/C,QAAA,KAAI,CAACK,qBAAL,CAA2BF,MAA3B;EACD,OAFc,CAAf;EAGD;;;4CAEqBA,QAAQ;EAC5B,UAAM3C,MAAM,GAAG,IAAI,KAAKuB,MAAL,CAAYuB,MAAhB,CAAuBH,MAAvB,CAAf;EAEA3C,MAAAA,MAAM,CAAC+C,OAAP,CAAe,KAAKrB,OAApB;EAEA,UAAMjC,eAAe,GAAG,KAAKC,WAA7B;EAEAM,MAAAA,MAAM,CAACC,KAAP,CAAa,KAAKC,WAAlB,EAA+BT,eAA/B;EAEA,WAAKE,KAAL,CAAWqD,IAAX,CAAgB;EACdlD,QAAAA,MAAM,EAAE,KAAKR,iBADC;EAEdU,QAAAA,MAAM,EAANA;EAFc,OAAhB;EAID;;;0BApEiB;EAAA,UACRiD,GADQ,GACA,KAAK1B,MAAL,CAAY2B,SADZ,CACRD,GADQ;EAEhB,aAAOA,GAAG,CAACvD,WAAJ,CAAgB,KAAK6B,MAAL,CAAY2B,SAAZ,CAAsBC,KAAtB,GAA8BjC,IAA9C,CAAP;EACD;;;0BAEiB;EAChB,aAAO,KAAKK,MAAL,CAAYO,OAAZ,CAAoB5B,WAA3B;EACD;;;wBAESS,OAAO;EACfA,MAAAA,KAAK,CAACoC,OAAN,CAAc,KAAKvB,yBAAnB;EACD;;;wBAEUZ,QAAQ;EAAA;;EACjB,WAAKjB,KAAL,CAAWI,OAAX,CAAmB,UAAAF,IAAI,EAAI;EACzBA,QAAAA,IAAI,CAACG,MAAL,CAAYoD,UAAZ,CAAuB,MAAI,CAAC1B,OAA5B;EACA7B,QAAAA,IAAI,CAACG,MAAL,CAAY+C,OAAZ,CAAoBnC,MAApB;EACD,OAHD;EAKA,WAAKc,OAAL,GAAed,MAAf;EACD;;;;;;MCpCKG,oBAAqCI,UAArCJ;MAAiBC,kBAAoBG,UAApBH;;MAEnBqC;;;EACJ,sCAAYH,SAAZ,EAAuB;EAAA;;EAAA;;EACrB,SAAKI,SAAL,GAAiBJ,SAAjB;EACA,SAAK5D,iBAAL,GAAyByB,iBAAzB;EAEA,SAAKuC,SAAL,CAAehD,EAAf,CAAkB,MAAlB,EAA0B,gBAAe;EAAA,UAAZiD,KAAY,QAAZA,KAAY;;EACvC,UAAIA,KAAK,GAAG,KAAI,CAACjE,iBAAb,KAAmC,CAAvC,EAA0C;EACxC,QAAA,KAAI,CAACgE,SAAL,CAAeE,QAAf,CAAwBC,IAAxB,CAA6B,MAA7B;EACD;EACF,KAJD;EAKD;;;;yBAEEC,OAAOC,SAAS;EACjB,WAAKL,SAAL,CAAehD,EAAf,CAAkBoD,KAAlB,EAAyBC,OAAzB;EACD;;;kDAE2B;EAC1B,UAAI7D,MAAM,GAAG,KAAKR,iBAAL,GAAyByB,iBAAtC;;EAEA,UAAIjB,MAAM,GAAGkB,eAAb,EAA8B;EAC5BlB,QAAAA,MAAM,GAAGiB,iBAAT;EACD;;EAED,WAAKzB,iBAAL,GAAyBQ,MAAzB;EACD;;;kDAE2B;EAC1B,UAAIA,MAAM,GAAG,KAAKR,iBAAL,GAAyByB,iBAAtC;;EAEA,UAAIjB,MAAM,GAAGiB,iBAAb,EAA8B;EAC5BjB,QAAAA,MAAM,GAAGkB,eAAT;EACD;;EAED,WAAK1B,iBAAL,GAAyBQ,MAAzB;EACD;;;;;;;;;;;;;;;;;;;"}